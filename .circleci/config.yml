version: 2.1

orbs:
  python: circleci/python@2.0.3

jobs:
  build-and-security-audit:
    docker:
      - image: cimg/python:3.10
    steps:
      - checkout
      - python/install-packages:
          pkg-manager: pip
      
      # Крок 1: Статичний аналіз коду (Linter + SAST)
      - run:
          name: Run SAST analysis with Bandit
          command: |
            pip install bandit
            bandit -r app.py -f json -o bandit_report.json || true
          when: always
      
      - store_artifacts:
          path: bandit_report.json
          destination: security-reports/bandit.json

      # Крок 2: Перевірка залежностей
      - run:
          name: Check dependencies with Safety
          command: |
            pip install safety
            safety check --full-report
      
      # Крок 3: Запуск Unit-тестів
      - run:
          name: Run Unit Tests
          command: |
            pip install pytest
            mkdir test-results
            pytest --junitxml=test-results/junit.xml tests/
      
      - store_test_results:
          path: test-results

workflows:
  main:
    jobs:
      - build-and-security-audit
