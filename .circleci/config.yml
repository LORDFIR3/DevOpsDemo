version: 2.1

orbs:
  python: circleci/python@2.0.3

jobs:
  build-and-security-audit:
    docker:
      - image: cimg/python:3.10
    steps:
      - checkout
      
      # ДОДАНО: Дозвіл на запуск Docker-команд (без версії, щоб уникнути помилки)
      - setup_remote_docker:
          docker_layer_caching: false

      - python/install-packages:
          pkg-manager: pip

      # --- ЕТАП 1: Перевірка коду ---
      - run:
          name: Run SAST analysis with Bandit
          command: |
            pip install --upgrade pip
            pip install pbr             # Виправляє помилку ModuleNotFoundError
            pip install --upgrade bandit # Встановлює новішу версію замість 1.7.0
            
            # Створюємо папку для звіту, якщо її немає (про всяк випадок)
            mkdir -p security-reports
            
            # Запускаємо сканування. 
            # || true гарантує, що пайплайн не впаде одразу, і ми отримаємо звіт
            bandit -r app.py -f json -o bandit_report.json --exit-zero
            
            # Виводимо результат в консоль, щоб ви могли зробити скріншот помилки debug=True
            bandit -r app.py -l high
          when: always

      - store_artifacts:
          path: bandit_report.json
          destination: security-reports/bandit.json

      - run:
          name: Check dependencies with Safety
          command: |
            pip install safety
            safety check --full-report || true

      # --- ЕТАП 2: Функціональне тестування ---
      - run:
          name: Run Unit Tests
          command: |
            pip install pytest
            mkdir -p test-results
            # ВИПРАВЛЕНО: PYTHONPATH=. щоб бачити app.py
            PYTHONPATH=. pytest --junitxml=test-results/junit.xml tests/

      - store_test_results:
          path: test-results

      # --- ЕТАП 3: Збірка Docker-образу ---
      - run:
          name: Build Docker Image
          command: |
            docker build -t calc-api:latest .

      # --- ЕТАП 4: Сканування образу ---
      - run:
          name: Install Trivy and Scan Image
          command: |
            # ДОДАНО sudo для запису в /usr/local/bin
            curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin
            
            # Сканування з виходом при критичних помилках
            trivy image --exit-code 1 --severity CRITICAL --no-progress calc-api:latest
            
            # Генерація звіту
            trivy image --format json --output trivy_report.json calc-api:latest || true

      - store_artifacts:
          path: trivy_report.json
          destination: security-reports/trivy.json

workflows:
  main:
    jobs:
      - build-and-security-audit
